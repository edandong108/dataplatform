# 双权限体系实现说明

## 概述

本系统实现了**平台级权限**和**项目级权限**的双权限体系，有效解决了全局权限管理和项目特定权限管理的分离问题。

## 权限体系架构

### 1. 平台级权限
- **管理范围**: 整个数据平台的全局功能
- **分配方式**: 在"用户管理"页面直接为用户分配平台角色
- **存储位置**: 用户数据中的 `platformRole` 字段
- **必填要求**: 所有用户必须分配平台角色，新用户默认为"普通用户"

#### 平台级角色
- **平台管理员** (`role_platform_admin`): 拥有所有平台管理权限，负责整个数据平台的运维和管理
- **平台运维** (`role_platform_ops`): 负责平台的日常运维工作，包括系统监控、性能优化和故障处理
- **平台审计** (`role_platform_audit`): 负责平台的审计工作，可查看所有日志和监控数据，但无修改权限
- **普通用户** (`role_platform_user`): 基础平台用户，可查看平台基础信息和个人相关数据（默认角色）

### 2. 项目级权限
- **管理范围**: 特定项目内的功能和数据
- **分配方式**: 通过"项目用户分配"页面为用户在特定项目中分配角色
- **存储位置**: 项目用户分配表 (`dataPlatformProjectUserAssignments`)

#### 项目级角色
- **项目管理员** (`role_project_manager`): 管理项目和项目内用户
- **项目开发者** (`role_project_developer`): 项目内数据开发
- **项目分析师** (`role_project_analyst`): 项目内数据分析
- **项目观察者** (`role_project_viewer`): 只读访问项目数据

## 数据结构

### 角色数据结构
```javascript
{
  id: 'role_platform_admin',
  name: '平台管理员',
  description: '拥有所有平台管理权限',
  type: 'platform', // 'platform' 或 'project'
  permissions: ['权限1', '权限2', ...],
  isCore: true // 核心角色不可删除
}
```

### 用户数据结构
```javascript
{
  id: 'user_001',
  username: '张伟',
  email: 'zhang.wei@company.com',
  status: 'active',
  platformRole: 'role_platform_admin', // 平台角色ID
  platformRoleAssignedAt: '2023-01-01T10:00:00Z', // 平台角色分配时间
  createdAt: '2023-01-01T10:00:00Z'
}
```

### 项目用户分配数据结构
```javascript
{
  id: 'assign_001',
  projectId: 'proj_001',
  userId: 'user_001',
  roleId: 'role_project_manager', // 项目级角色ID
  assignedAt: '2023-01-01T10:00:00Z'
}
```

## 页面功能

### 1. 角色管理 (`role_management.html`)
- 管理所有角色（平台级和项目级）
- 显示角色类型标识
- 配置角色权限

### 2. 用户管理 (`user_management.html`) **★ 集成了平台权限分配功能**
- 管理用户基本信息
- **直接分配和管理用户的平台角色**
- 显示用户所属的项目
- 新用户必须分配平台角色，默认为"普通用户"
- 角色变更时自动记录分配时间

### 3. 项目用户分配 (`project_user_management.html`)
- 为特定项目分配用户和项目级角色
- 只显示项目级角色选项
- 支持项目维度的用户管理

### 4. 权限体系测试 (`permission_test.html`)
- 可视化展示双权限体系的配置情况
- 显示平台级和项目级角色
- 显示用户权限分配情况

## 用户界面优化

### 平台角色视觉标识
- **平台管理员**: 粉红色徽章
- **平台运维**: 绿色徽章  
- **平台审计**: 蓝色徽章
- **普通用户**: 青色徽章

## 使用流程

### 平台权限分配流程（简化）
1. 进入"用户管理"页面
2. 新增用户或编辑现有用户
3. 在表单中选择平台角色（新用户默认为"普通用户"）
4. 保存后系统自动记录分配时间

### 项目权限分配流程
1. 进入"项目用户分配"页面
2. 选择项目
3. 为项目添加用户并分配项目级角色
4. 系统记录项目分配关系

## 权限分离的优势

### 1. 清晰的职责分离
- **平台级**: 系统管理、用户管理、全局配置
- **项目级**: 项目数据、项目资源、项目团队

### 2. 灵活的权限组合
- 用户可以同时拥有平台角色和多个项目角色
- 不同项目中可以有不同的角色权限

### 3. 安全性提升
- 平台管理权限与项目权限隔离
- 项目间权限互不影响

### 4. 管理便利性
- 平台权限直接在用户管理中配置，操作简洁
- 项目管理员可以独立管理项目内权限

## 技术实现要点

### 1. 强制平台角色分配
- 所有用户必须有平台角色，表单验证确保必填
- 新用户默认分配"普通用户"角色
- 移除了"无平台角色"选项

### 2. 角色类型过滤
- 用户管理页面: `roles.filter(r => r.type === 'platform')`
- 项目权限分配页面: `roles.filter(r => r.type === 'project')`

### 3. 数据存储分离
- 平台角色存储在用户对象中
- 项目角色存储在独立的分配表中

### 4. 权限继承和组合
- 用户最终权限 = 平台角色权限 + 所有项目角色权限
- 不同层级权限可以叠加使用

## 扩展性

该双权限体系设计具有良好的扩展性：
- 可以轻松添加新的平台级或项目级角色
- 支持更细粒度的权限控制
- 可以扩展到部门级、团队级等更多层级 